#!/usr/bin/env bash
# ArchBANG main menu for Waybar â†’ Rofi (Sway Wayland)
# Flat main menu: Terminal, Files, Browser, System (submenu), Power (submenu with confirms)
# Adapted from SwayBang for Sway
# Author: Mr Green

set -euo pipefail

ROFI="${ROFI:-rofi}"
DM() {
  local prompt="$1"
  local line_count="$2"
  "$ROFI" -dmenu -i -p "$prompt" -lines "$line_count"
}
have() { command -v "$1" >/dev/null 2>&1; }

# Fixed apps
TERM="foot"
FILEMGR="thunar"
BROWSER="firefox"

# Document paths
GUIDE_PATH="$HOME/Documents/Guide"
KEYBINDS_PATH="$HOME/Documents/keybinds.txt"

# --- System submenu ---
system_menu() {
    local items=("  Reload Sway" "  Restart Waybar")
    have abinstall && items+=("  Install ArchBANG")
    have gparted && items+=("  GParted")
    [ -f "$GUIDE_PATH" ]    && items+=("  Guide")
    [ -f "$KEYBINDS_PATH" ] && items+=("  Keybinds")
  sel="$(printf "%s\n" "${items[@]}" | DM "System" "${#items[@]}")" || exit 0
  case "$sel" in
    *Reload\ Sway*)        exec swaymsg reload ;;
    *Restart\ Waybar*)     pkill -x waybar; waybar & disown ;;
    *Install\ ArchBANG*)   exec foot -e sudo -E "$HOME/AB_Scripts/abinstall" ;;
    *GParted*)
      notify-send "GParted" "Running GParted as root" --icon=gparted
      sudo -EH gparted & disown
      ;;
    *Guide*)               exec "$BROWSER" "$GUIDE_PATH" ;;
    *Keybinds*)            exec l3afpad "$KEYBINDS_PATH" ;;
  esac
}


# --- Power submenu (with confirm) ---
confirm() { choice=$(printf "No\nYes" | DM "$1" 2) || exit 0; [ "$choice" = "Yes" ]; }

power_menu() {
    local items=("  Lock" "  Suspend" "  Reboot" "  Shutdown" "  Logout")
  sel=$(printf "%s\n" "${items[@]}" | DM "Power" "${#items[@]}") || exit 0
  case "$sel" in
    *Lock*)     have swaylock && exec swaylock ;;
    *Suspend*)  confirm "Suspend?"   && exec systemctl suspend ;;
    *Reboot*)   confirm "Reboot?"    && exec systemctl reboot ;;
    *Shutdown*) confirm "Power off?" && exec systemctl poweroff ;;
    *Logout*)   confirm "Exit Sway?" && pkill -x sway ;;
  esac
}

# --- Main unified menu ---
main_menu() {
  local menu_items=(
  "  Terminal"
  "  Files"
  "  Browser"
  "  System"
  "  Power"
  )
  sel=$(printf "%s\n" "${menu_items[@]}" | DM "Menu" "${#menu_items[@]}") || exit 0
  case "$sel" in
    *Terminal*)     exec "$TERM" ;;
    *Files*)        exec "$FILEMGR" ;;
    *Browser*)      exec "$BROWSER" ;;
    *System*)       system_menu ;;
    *Power*)        power_menu ;;
  esac
}

main_menu
